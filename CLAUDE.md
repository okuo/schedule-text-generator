# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## プロジェクト概要

このプロジェクトはVanilla JavaScriptベースのスケジュールテキスト生成ツールです。外部フレームワークに依存せず、純粋なHTML、CSS、JavaScriptで実装されています。

## コマンド

### 開発環境
- **ローカルサーバー起動**: `python -m http.server 8000` または `npx serve .`
- **ファイル監視**: Live Server拡張機能を使用するかブラウザで直接HTMLファイルを開く

### 祝日データ管理
- **祝日データ更新**: `node scripts/fetch-holidays.js`
- **GitHub Actions実行**: 手動で「Update Holiday Data」ワークフローを実行
- **自動更新**: 毎年12月1日午前0時（UTC）に自動実行

### テスト
- **単体テスト**: テストフレームワークが設定されている場合、通常のJavaScriptテスト実行
- **ブラウザテスト**: 開発者ツールのコンソールでテスト
- **祝日データテスト**: ローカルサーバー起動後にブラウザで祝日表示を確認

## アーキテクチャ

### ディレクトリ構造
```
/
├── index.html          # メインエントリーポイント
├── .github/workflows/  # GitHub Actions設定
│   └── update-holidays.yml # 祝日データ自動更新
├── scripts/           # Node.jsスクリプト
│   └── fetch-holidays.js # 祝日データ取得スクリプト
├── css/               # スタイルシート
│   └── style.css
├── js/                # JavaScriptモジュール
│   ├── main.js        # メインロジック
│   ├── scheduler.js   # スケジュール処理
│   ├── textGenerator.js # テキスト生成
│   └── holidayService.js # 祝日判定サービス
└── assets/            # 静的リソース
    └── holidays.json  # 祝日データ（自動生成）
```

### 設計パターン
- **モジュールパターン**: 機能ごとにJSファイルを分離
- **イベント駆動**: DOM操作とユーザーインタラクション
- **関数型アプローチ**: 純粋関数でのデータ変換

### 主要コンポーネント
- **Scheduler**: スケジュールデータの管理と操作
- **TextGenerator**: スケジュールからテキスト形式への変換
- **HolidayService**: 祝日判定とデータ管理（外部API連携）
- **UI Controller**: DOM操作とユーザーイベント処理

### データフロー
1. アプリ起動 → 祝日サービス初期化（外部JSONデータ読み込み）
2. ユーザー入力 → スケジュールデータ構造
3. 日付選択 → 祝日判定 → UI表示（カレンダー色分け）
4. スケジュールデータ → テキスト生成処理
5. 生成されたテキスト → UI表示/エクスポート

## 開発時の注意点

### 基本ルール
- ES6+モジュール構文を使用する場合は `type="module"` を指定
- ブラウザ互換性を考慮したJavaScript記述
- CORSエラー対策のためローカルサーバーを使用
- デバッグにはブラウザの開発者ツールを活用

### 実装の重要な制約
- **セル選択のトグル機能**: `isSelectedCell()`と`findCandidateByCell()`で選択状態を正確に判定
- **ドラッグ選択の整合性**: `updateSelectionDisplay`と`markSelectedCells`の条件は一致させること
- **時間計算の統一**: シングルクリック（15分）とドラッグ選択で適切に時間範囲を計算（+15分処理）
- **ドラッグ時間表示**: `updateDragTimeDisplay`で終了時刻に15分追加の統一処理
- **マウスイベントの処理**: ドラッグ中の状態管理と表示更新を同期
- **日付ヘッダークリック**: 終日選択のトグル機能とイベントリスナーの重複回避
- **今日表示の優先順位**: 選択状態でも今日の下線を表示（z-index調整）
- **祝日サービスの初期化**: `main.js`で`HolidayService`の初期化を確実に行うこと
- **文字エンコーディング**: 内閣府CSVはShift_JIS形式、適切なデコード処理が必要
- **タイムゾーン処理**: 祝日データ生成時は`toISOString()`を避け手動でYYYY-MM-DD形式を作成
- **iPhone最適化**: 480px以下で`grid-template-columns: 40px repeat(7, minmax(45px, 1fr))`設定

### UI/UXの考慮事項
- **フォント**: Windows 11の`Segoe UI Variable Display`を優先使用
- **色の統一性**: 選択中（`#34d399`）と確定後（`#34d399`）の色を統一
- **レスポンシブ**: 画面サイズに応じた適切な表示

## 最新の実装状況

### v1.5の主要機能（操作性・表示改善版）
- **セルトグル機能**: 選択済みセルをクリックして選択解除が可能
- **時刻表示統一**: ドラッグ選択で「17:45→18:00」等、正確な終了時刻を表示
- **スケジュール終了時刻**: 17:45まで選択可能、18:00表示なし（9:00-17:00の8時間対応）
- **iPhone完全対応**: 480px以下の画面で横スクロールなしの一週間表示を実現
- **カレンダー終端デザイン**: 17:45行の下に統一感のある境界線を追加
- **タッチ操作最適化**: iPhone向けのセルサイズとレイアウト調整

### v1.4の主要機能（UI強化版）
- **日付ヘッダークリック機能**: 日付をクリックして終日選択（トグル対応）
- **終日表示フォーマット**: 「9月4日（木）」形式で時間なし表示
- **今日の表示改善**: グレー下線による控えめな強調表示
- **日付ヘッダー選択状態**: 緑色背景で視覚的フィードバック
- **リセット機能強化**: 日付ヘッダー選択もリセット対象に追加
- **選択一覧の密度改善**: 項目間スペースを最適化
- **祝日データ精度向上**: タイムゾーン問題を修正、正確な日付表示

### v1.3の主要機能（外部API祝日対応）
- **外部API祝日連携**: 内閣府公式CSVから祝日データを自動取得
- **GitHub Actions自動化**: 毎年12月1日に祝日データを自動更新
- **Shift_JIS対応**: 日本語祝日名の文字化け問題を解決
- **データ最適化**: 現在年以降のデータのみ保持（96%サイズ削減）
- **HolidayService**: 非同期初期化とフォールバック機能を実装

### v1.2の主要機能
- **リアルタイム時間表示**: `showDragTimeDisplay()`でドラッグ中に時間範囲表示
- **選択精度の改善**: シングルクリックとドラッグ選択の正確な区別
- **UI最適化**: ヘッダースペース削減、フォントサイズ調整

### 既知の制約・課題
- 同日内選択のみ対応（複数日選択非対応）
- 9:00-17:00の固定時間範囲（17:45まで選択可能、18:00で終了）
- GitHub Actions PR作成権限の制約（ブランチ作成のみ、PR作成は手動）
- 日付ヘッダーの選択状態は週移動時に自動復元されない
- カレンダー下部の余白問題（flex: 1による垂直伸展）

### 祝日データ管理システム
- **データソース**: 内閣府「国民の祝日」CSV（https://www8.cao.go.jp/chosei/shukujitsu/syukujitsu.csv）
- **更新頻度**: 年1回（12月1日午前0時UTC）
- **データ範囲**: 現在年（2025年）以降の祝日のみ
- **ファイルサイズ**: 約2.8KB（最適化済み）
- **文字エンコーディング**: Shift_JIS自動デコード対応
- **フォールバック**: API障害時は基本的な固定祝日で動作